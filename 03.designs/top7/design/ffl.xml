<ROSETTASCRIPTS>

  <SCOREFXNS>

    # SCOREFUNCTION
    # 	Full atom score function is defined that will be used to score repacking in the NubInitioMover:
    <ScoreFunction name="fullatom" weights="talaris2014" >
      <Reweight scoretype="chainbreak"         weight="1.0" />
      <Reweight scoretype="linear_chainbreak"  weight="1.0" />
      <Reweight scoretype="overlap_chainbreak" weight="1.0" />
    </ScoreFunction>

  </SCOREFXNS>

  <RESIDUE_SELECTORS>

    # TEMPLATE - INSERTION REGION ON TOP7
    # 	Structure and Sequence information from Top7 (referred to as "TEMPLATE") will be used to guide the refolding
    #   of the grafted protein in the NubInitioMover.
    #   The regions that will be substituted by the epitope and its pairing strand are defined here:
    <Chain name="templateChain"   chains="A" />
    <Index name="insertion1"      resnums="5A-8A" />
    <Index name="insertion2"      resnums="15A-21A" />
    <Or    name="full_insertion"  selectors="insertion1,insertion2" />
    <Not   name="!full_insertion" selector="full_insertion" />

    # MOTIF - EPITOPE AND PAIRING STRAND
    #   The epitope, pairing strand and antibody together will be loaded into the script as one pdb-file.
    #   The segments that will replace corresponding regions in Top7 are refererd to as "MOTIF" and defined here:
    <Index name="motif1"          resnums="4P-7P" />
    <Index name="motif2"          resnums="13P-19P" />
    <Or    name="full_motif"      selectors="motif1,motif2" />
    <Not   name="!full_motif"     selector="full_motif" />

    # BINDER
    # 	The 101F Fab heavy and light chains (referred to as "BINDER) will be hold rigid
    #   during the grafting process and are defined here:
    <Chain name="101F_HC"         chains="H" />
    <Chain name="101F_LC"         chains="L" />
    <Or    name="101F_Fab"        selectors="101F_HC,101F_LC" />

    # DESIGN
    # 	To make sure that the chain naming of the output pose (referred to as DESIGN) is unambiguous, it is defined
    #   to carry the same chain name as the epitope MOTIF (P). Binder chains are kept as "H" and "L":
    <Chain name="designChain"     chains="P" />
  </RESIDUE_SELECTORS>


  <FILTERS>

    # FILTER1: RMSD
    #  	Measures the RMSD between the output design and Top7:
    <RmsdFromResidueSelectorFilter name="final_rmsd" reference_name="template_pose"
      reference_selector="templateChain" query_selector="designChain" confidence="0" />

    # FILTER2: SCORE
    #  	Scores the output pose based only on the grafted protein chain and disregards the score of the 101F-Fab:
    <ScorePoseSegmentFromResidueSelectorFilter name="design_score" confidence="0" residue_selector="designChain" />

  </FILTERS>

  <MOVERS>

    # LOADING THE MOTIF-PDB
    # 	The pdb-file from which the MOTIF (epitope and pairing strand) and the BINDER (101F Fab) are obtained is loaded.
    # 	(This mover doesn't need to be called again in the final protocol):
    <SavePoseMover name="load_motif" reference_name="motif_pose" pdb_file="./motif.pdb" />


    # SAVING THE TEMPLATE POSE
    #   The Top7 pose (TEMPLATE) is saved in order to measure the final RMSD of the design:
    <SavePoseMover name="saveTemplate" restore_pose="0" reference_name="template_pose" />

    # FRAGMENTS
    # 	The fragment files were previsouly generated by calling a generic fragment-picking script ("mkfragments.xml")
    #   The fragment files are loaded here:
    <StructFragmentMover name="FragmentPicker" prefix="frags" output_frag_files="0" small_frag_file="frags.200.3mers"
        large_frag_file="frags.200.9mers" />

    # CONSTRAINTS
    # 	Atompair Constraints are derived from Top7 (TEMPLATE) to guide the refolding process in the NubInitioMover:
    <AddConstraints name="addCST" >
      <AtomPairConstraintGenerator name="atompairCST" sd="5.0" ca_only="true" min_seq_sep="6"
        use_harmonic="true" unweighted="true" max_distance="40" residue_selector="templateChain" />
    </AddConstraints>

    # REMOVAL OF CONSTRAINTS
    # 	After the refolding step, the constraints are removed again:
    <ClearConstraintsMover name="cleanCST" />

    # GRAFTING AND REFOLDING
    # 	This step constitutes the core of the FFL protocol and refolds Top7 (TEMPLATE) around the epitope (MOTIF)
    #   in presence of 101F Fab (BINDER) using the above loaded fragments.
    #   The insertions are placed into Top7 in the same order as in the original motif as defined by the segment order subtag.
    #   Slight backbone movements of the corresponding C-terminal residues are allowed ("flexible"):
    <NubInitioMover name="FFL" fragments_id="frags" template_motif_selector="full_insertion" fullatom_scorefxn="fullatom"
        dump_centroid="true" >
      <Nub reference_name="motif_pose" residue_selector="full_motif" binder_selector="101F_Fab" >
        <Segment order="1" c_term_flex="1" />
        <Segment order="2" c_term_flex="1" />
      </Nub>
    </NubInitioMover>

    # LOOP CLOSURE
    # 	This mover ensures that the output structure has no chainbreaks.
    # 	Linearises the FoldTree centred on the first insertion motif:
    <NubInitioLoopClosureMover name="FFLCCD" fragments_id="frags" break_side_ramp="true" />

  </MOVERS>

  <PROTOCOLS>
    # Preparing Top7 structure
    <Add mover="saveTemplate" />
    <Add mover="FragmentPicker" />
    <Add mover="addCST" />
    # Grafting and Refolding
    <Add mover="FFL" />
    <Add mover="cleanCST" />
    <Add mover="FFLCCD" />
    # Evaluation of results
    <Add filter="final_rmsd" />
    <Add filter="design_score" />
  </PROTOCOLS>
  <OUTPUT />
</ROSETTASCRIPTS>
