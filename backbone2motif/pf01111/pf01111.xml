<ROSETTASCRIPTS>

  <SCOREFXNS>
    # A weight is added to small-range hbonds to favor helix, and beta pairing
    # and to take residue propensity into account. This way, we can favor
    # helix-forming residues in our designs.
    <ScoreFunction name="fullatom" weights="talaris2014">
      <Reweight scoretype="hbond_sr_bb"    weight="1.6"/>
      <Reweight scoretype="hbond_lr_bb"    weight="1.6"/>
      <Reweight scoretype="aa_composition" weight="1.0" />
    </ScoreFunction>
  </SCOREFXNS>

  <RESIDUE_SELECTORS>
    # Standard FFL ResidueSelectors.
    <xi:include href="xml_pieces/selectors.xml" />

    # TEMPLATE (1dks)
    <Index name="template"   resnums="6B-73B" />
    <Not   name="!template"  selector="template" />
    <Index name="insertion"  resnums="34B-37B" />
    <Not   name="!insertion" selector="insertion" />
    <And   name="tused"      selectors="template,!insertion" />

    <Index name="t1"   resnums="6B-12B" />
    <Index name="t2"   resnums="18B-24B" />
    <Index name="t3"   resnums="26B-30B" />
    <Index name="t4"   resnums="41B-46B" />
    <Index name="t5"   resnums="54B-60B" />
    <Index name="t6"   resnums="65B-70B" />
    <Or    name="tall" selectors="t1,t2,t3,t4,t5,t6" />

    # QUERY (4lpa)
    <Index name="motif"  resnums="56A-68A" />
    <Not   name="!motif" selector="motif" />
    <Chain name="design" chains="A" />
    <Index name="query"  resnums="28A-104A" />
    <And   name="qused"  selectors="query,!motif" />

    <Index name="q1"   resnums="28A-34A" />
    <Index name="q2"   resnums="40A-46A" />
    <Index name="q3"   resnums="48A-52A" />
    <Index name="q4"   resnums="72A-77A" />
    <Index name="q5"   resnums="85A-91A" />
    <Index name="q6"   resnums="96A-101A" />
    <Or    name="qall" selectors="q1,q2,q3,q4,q5,q6" />

    # DESIGN
    <ResiduePDBInfoHasLabel name="D1" property="T1" />
    <ResiduePDBInfoHasLabel name="D2" property="T2" />
    <ResiduePDBInfoHasLabel name="D3" property="T3" />
    <ResiduePDBInfoHasLabel name="D4" property="T4" />
    <ResiduePDBInfoHasLabel name="D5" property="T5" />
    <ResiduePDBInfoHasLabel name="D6" property="T6" />
    <ResiduePDBInfoHasLabel name="DA" property="TA" />

  </RESIDUE_SELECTORS>

  <MOVE_MAP_FACTORIES>
    # Standard FFL MoveMap
    <xi:include href="xml_pieces/movemap.xml" />
  </MOVE_MAP_FACTORIES>

  <TASKOPERATIONS>
    # Standard FFL TaskOperators
    <xi:include href="xml_pieces/taskoperators.xml" />
  </TASKOPERATIONS>

  <FILTERS> # (confidence=0 -> to score not to filter)

    # Globals
    <RmsdFromResidueSelectorFilter name="tglob" reference_name="template_pose"
       reference_selector="tall" query_selector="DA" confidence="0" />
    <RmsdFromResidueSelectorFilter name="qglob" reference_name="motif_pose"
       reference_selector="qall" query_selector="DA" confidence="0" />

    # Locals
    <RmsdFromResidueSelectorFilter name="rmsdT1" superimpose="false" confidence="0"
      reference_name="template_pose" reference_selector="t1" query_selector="D1"  />
    <RmsdFromResidueSelectorFilter name="rmsdT2" superimpose="false" confidence="0"
      reference_name="template_pose" reference_selector="t2" query_selector="D2"  />
    <RmsdFromResidueSelectorFilter name="rmsdT3" superimpose="false" confidence="0"
      reference_name="template_pose" reference_selector="t3" query_selector="D3"  />
    <RmsdFromResidueSelectorFilter name="rmsdT4" superimpose="false" confidence="0"
      reference_name="template_pose" reference_selector="t4" query_selector="D4"  />
    <RmsdFromResidueSelectorFilter name="rmsdT5" superimpose="false" confidence="0"
      reference_name="template_pose" reference_selector="t5" query_selector="D5"  />
    <RmsdFromResidueSelectorFilter name="rmsdT6" superimpose="false" confidence="0"
      reference_name="template_pose" reference_selector="t6" query_selector="D6"  />
    <RmsdFromResidueSelectorFilter name="rmsdTA" superimpose="false" confidence="0"
      reference_name="template_pose" reference_selector="tall" query_selector="DA"  />

    <RmsdFromResidueSelectorFilter name="rmsdQ1" superimpose="false" confidence="0"
      reference_name="motif_pose" reference_selector="q1" query_selector="D1"  />
    <RmsdFromResidueSelectorFilter name="rmsdQ2" superimpose="false" confidence="0"
      reference_name="motif_pose" reference_selector="q2" query_selector="D2"  />
    <RmsdFromResidueSelectorFilter name="rmsdQ3" superimpose="false" confidence="0"
      reference_name="motif_pose" reference_selector="q3" query_selector="D3"  />
    <RmsdFromResidueSelectorFilter name="rmsdQ4" superimpose="false" confidence="0"
      reference_name="motif_pose" reference_selector="q4" query_selector="D4"  />
    <RmsdFromResidueSelectorFilter name="rmsdQ5" superimpose="false" confidence="0"
      reference_name="motif_pose" reference_selector="q5" query_selector="D5"  />
    <RmsdFromResidueSelectorFilter name="rmsdQ6" superimpose="false" confidence="0"
      reference_name="motif_pose" reference_selector="q6" query_selector="D6"  />
    <RmsdFromResidueSelectorFilter name="rmsdQA" superimpose="false" confidence="0"
      reference_name="motif_pose" reference_selector="qall" query_selector="DA"  />

    <BuriedUnsatHbonds name="BUNS" jump_number="0" confidence="0"
      task_operations="FFLMOTIF_TASKOP,FFLFLEX_TASKOP,FFLTEMPLATE_TASKOP" />
    <PackStat name="packstat" repeats="5" chain="1" confidence="0" />
    <CavityVolume name="cav_vol" confidence="0" />
  </FILTERS>

  <MOVERS>
    ## PREPROCESSING: LABELING TEMPLATE
    <LabelPoseFromResidueSelectorMover name="tlab1" property="T1" residue_selector="t1" />
    <LabelPoseFromResidueSelectorMover name="tlab2" property="T2" residue_selector="t2" />
    <LabelPoseFromResidueSelectorMover name="tlab3" property="T3" residue_selector="t3" />
    <LabelPoseFromResidueSelectorMover name="tlab4" property="T4" residue_selector="t4" />
    <LabelPoseFromResidueSelectorMover name="tlab5" property="T5" residue_selector="t5" />
    <LabelPoseFromResidueSelectorMover name="tlab6" property="T6" residue_selector="t6" />
    <LabelPoseFromResidueSelectorMover name="tlab0" property="TA" residue_selector="tall" />
    <ParsedProtocol name="labelingT">
      <Add mover_name="tlab1" />
      <Add mover_name="tlab2" />
      <Add mover_name="tlab3" />
      <Add mover_name="tlab4" />
      <Add mover_name="tlab5" />
      <Add mover_name="tlab6" />
      <Add mover_name="tlab0" />
    </ParsedProtocol>

    ## PREPROCESSING: LABELING QUERY
    <LabelPoseFromResidueSelectorMover name="qlab1" property="Q1" residue_selector="q1" />
    <LabelPoseFromResidueSelectorMover name="qlab2" property="Q2" residue_selector="q2" />
    <LabelPoseFromResidueSelectorMover name="qlab3" property="Q3" residue_selector="q3" />
    <LabelPoseFromResidueSelectorMover name="qlab4" property="Q4" residue_selector="q4" />
    <LabelPoseFromResidueSelectorMover name="qlab5" property="Q5" residue_selector="q5" />
    <LabelPoseFromResidueSelectorMover name="qlab6" property="Q6" residue_selector="q6" />
    <LabelPoseFromResidueSelectorMover name="qlab0" property="QA" residue_selector="qall" />
    <ParsedProtocol name="labelingQ">
      <Add mover_name="qlab1" />
      <Add mover_name="qlab2" />
      <Add mover_name="qlab3" />
      <Add mover_name="qlab4" />
      <Add mover_name="qlab5" />
      <Add mover_name="qlab6" />
      <Add mover_name="qlab0" />
    </ParsedProtocol>

    ## PREPROCESSING: STORING INPUT STRUCTURES
    <SavePoseMover name="saveTmplt" reference_name="template_pose" restore_pose="0" />
    <SavePoseMover name="loadTmplt" reference_name="template_pose" restore_pose="1" />
    <SavePoseMover name="saveFlded" reference_name="folded_pose"   restore_pose="0" />
    # ** SavePoseMover used like this does not need to be called during PROTOCOL to work.
    <SavePoseMover name="readMotif" reference_name="motif_pose" pdb_file="4lpaA.pdb" />
    <SavePoseMover name="saveMotif" reference_name="motif_pose" restore_pose="0" />
    <SavePoseMover name="loadMotif" reference_name="motif_pose" restore_pose="1" />

    ## PREPROCESSING: LIMITING STRUCTURE TO TEMPLATE
    <DeleteRegionMover name="cleanChains" residue_selector="!template" />

    ## PREPROCESSING: MAKING FRAGMENTS
    <StructFragmentMover name="makeFrags" prefix="pf01111" vall_file="database/vall.jul19.2011.gz"
      small_frag_file="pf01111.200.3mers" large_frag_file="pf01111.200.9mers" output_frag_files="true"
    />

    ## PREPROCESSING: CONSTRAINTS
    <AddConstraints name="foldingCST" >
      <AtomPairConstraintGenerator name="atompairCST1" sd="3.5" ca_only="true"
        use_harmonic="true" unweighted="true" min_seq_sep="6" max_distance="40" residue_selector="template"
      />
    </AddConstraints>

    # MAIN: NUBINITIO FOLDING
    <NubInitioMover name="FFL" fragments_id="pf01111" template_motif_selector="insertion" drop_unfolded_pose="false"
      use_cst="true" rmsd_threshold="5" fullatom_scorefxn="fullatom" >
      <Nub reference_name="motif_pose" residue_selector="motif" >
        <Segment order="1" n_term_flex="1" c_term_flex="1" />
      </Nub>
    </NubInitioMover>

    # POSTPROCESSING: CONSTRAINTS
    <AddConstraints name="designCST" >
      <AtomPairConstraintGenerator name="atompairCST2" sd="1.5" ca_only="true"
        use_harmonic="true" unweighted="true" min_seq_sep="6" max_distance="40" residue_selector="design"
      />
    </AddConstraints>
    <ClearConstraintsMover name="clearCST" />

    # POSTPROCESSING: SEQUENCE CONSTRAINTS
    <AddHelixSequenceConstraints name="compositionCST" />

    # POSTPROCESSING: DESING
    <FastDesign name="DesignRelax" scorefxn="fullatom" clear_designable_residues="true"
      task_operations="FFLMOTIF_TASKOP,FFLFLEX_TASKOP,FFLTEMPLATE_TASKOP"
      repeats="3" delete_virtual_residues_after_FastRelax="true"
      movemap_factory="FFLSTANDARD_MOVEMAP" >
    </FastDesign>

    ## VERBOSE
    <DisplayPoseLabelsMover name="showDesign" movemap_factory="FFLSTANDARD_MOVEMAP"
      task_operations="FFLMOTIF_TASKOP,FFLFLEX_TASKOP,FFLTEMPLATE_TASKOP" />

  </MOVERS>

  <PROTOCOLS>
    # PREPROCESSING: LABELING
    <Add mover="labelingT"  />
    <Add mover="showDesign" />
    <Add mover="saveTmplt"  />
    <Add mover="loadMotif"  />
    <Add mover="labelingQ"  />
    <Add mover="showDesign" />
    <Add mover="saveMotif"  />
    <Add mover="loadTmplt"  />
    # PREPROCESSING
    <Add mover="cleanChains" />
    <Add mover="makeFrags"   />
    <Add mover="saveTmplt"   />
    <Add mover="foldingCST"  />
    # MAIN
    <Add mover="FFL"        />
    <Add mover="showDesign" />
    <Add mover="clearCST"   />
    <Add mover="saveFlded"  />
    # POSTPROCESSING
    <Add mover="designCST"      />
    <Add mover="compositionCST" />
    <Add mover="DesignRelax"    />
    <Add mover="clearCST"       />
    # EVALUATION
    <Add filter="tglob"  />
    <Add filter="qglob"  />
    <Add filter="rmsdT1" />
    <Add filter="rmsdT2" />
    <Add filter="rmsdT3" />
    <Add filter="rmsdT4" />
    <Add filter="rmsdT5" />
    <Add filter="rmsdT6" />
    <Add filter="rmsdTA" />
    <Add filter="rmsdQ1" />
    <Add filter="rmsdQ2" />
    <Add filter="rmsdQ3" />
    <Add filter="rmsdQ4" />
    <Add filter="rmsdQ5" />
    <Add filter="rmsdQ6" />
    <Add filter="rmsdQA" />
    <Add filter="BUNS"     />
    <Add filter="packstat" />
    <Add filter="cav_vol"  />
  </PROTOCOLS>

</ROSETTASCRIPTS>
